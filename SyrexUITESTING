-- Syrex UI Library - With Loading Screen & Fixed Draggable

if game.CoreGui:FindFirstChild("SyrexUILib") then
    game.CoreGui.SyrexUILib:Destroy()
end

local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local TweenService = game:GetService("TweenService")

local Theme = {
    Background = Color3.fromRGB(9,9,13),
    Section = Color3.fromRGB(0,20,40),
    Element = Color3.fromRGB(61,133,224),
    Text = Color3.fromRGB(255,255,255),
}

local Settings = {
    CloseBind = Enum.KeyCode.RightControl,
}

-- UI Configuration
local UIConfig = {
    Title = "SyrexUI",
    Subtitle = "SyrexUI", 
    LoadingText = "SyrexUI",
    TitleSize = 24,
    SubtitleSize = 14,
    LoadingTextSize = 16,
}

-- ScreenGui
local Gui = Instance.new("ScreenGui")
Gui.Name = "SyrexUILib"
Gui.Parent = CoreGui
Gui.ResetOnSpawn = false

-- Loading Screen
local LoadingFrame = Instance.new("Frame")
LoadingFrame.Size = UDim2.new(0, 400, 0, 200)
LoadingFrame.Position = UDim2.new(0.5, -200, 0.5, -100)
LoadingFrame.BackgroundColor3 = Theme.Background
LoadingFrame.Parent = Gui
Instance.new("UICorner", LoadingFrame).CornerRadius = UDim.new(0,6)

local LoadingTitle = Instance.new("TextLabel", LoadingFrame)
LoadingTitle.Size = UDim2.new(1, -40, 0, 60)
LoadingTitle.Position = UDim2.new(0, 20, 0, 30)
LoadingTitle.BackgroundTransparency = 1
LoadingTitle.Text = UIConfig.Title
LoadingTitle.TextColor3 = Theme.Text
LoadingTitle.Font = Enum.Font.FredokaOne
LoadingTitle.TextSize = UIConfig.TitleSize
LoadingTitle.TextXAlignment = Enum.TextXAlignment.Center

local LoadingSubtitle = Instance.new("TextLabel", LoadingFrame)
LoadingSubtitle.Size = UDim2.new(1, -40, 0, 30)
LoadingSubtitle.Position = UDim2.new(0, 20, 0, 90)
LoadingSubtitle.BackgroundTransparency = 1
LoadingSubtitle.Text = UIConfig.LoadingText  -- This shows "SyrexUI" in loading screen
LoadingSubtitle.TextColor3 = Color3.fromRGB(200,200,200)
LoadingSubtitle.Font = Enum.Font.SourceSans
LoadingSubtitle.TextSize = UIConfig.LoadingTextSize
LoadingSubtitle.TextXAlignment = Enum.TextXAlignment.Center

local LoadingBar = Instance.new("Frame", LoadingFrame)
LoadingBar.Size = UDim2.new(0.8, 0, 0, 4)
LoadingBar.Position = UDim2.new(0.1, 0, 0, 140)
LoadingBar.BackgroundColor3 = Theme.Section
LoadingBar.BorderSizePixel = 0
Instance.new("UICorner", LoadingBar).CornerRadius = UDim.new(1,0)

local LoadingBarFill = Instance.new("Frame", LoadingBar)
LoadingBarFill.Size = UDim2.new(0, 0, 1, 0)
LoadingBarFill.BackgroundColor3 = Theme.Element
LoadingBarFill.BorderSizePixel = 0
Instance.new("UICorner", LoadingBarFill).CornerRadius = UDim.new(1,0)

-- Main GUI Frame (initially hidden)
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0,520,0,340)
MainFrame.Position = UDim2.new(0.5,-260,0.5,-170)
MainFrame.BackgroundColor3 = Theme.Background
MainFrame.Active = true
MainFrame.Parent = Gui
MainFrame.Visible = false
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0,6)

-- Floating Tab Bar (initially hidden)
local TabFrame = Instance.new("Frame")
TabFrame.Size = UDim2.new(0,100,0,340)
TabFrame.Position = UDim2.new(0.5,-370,0.5,-170)
TabFrame.BackgroundColor3 = Theme.Background
TabFrame.Parent = Gui
TabFrame.Visible = false
Instance.new("UICorner", TabFrame).CornerRadius = UDim.new(0,6)

-- GUI Toggle Button (initially hidden)
local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(0, 80, 0, 40)
ToggleBtn.Position = UDim2.new(0, 10, 0.5, -20)
ToggleBtn.BackgroundColor3 = Theme.Element
ToggleBtn.Text = "Close"
ToggleBtn.TextColor3 = Theme.Text
ToggleBtn.Font = Enum.Font.SourceSansBold
ToggleBtn.TextSize = 16
ToggleBtn.Visible = false
ToggleBtn.Parent = CoreGui
ToggleBtn.ZIndex = 10
Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0,6)

-- Enhanced TopBar with Title (no animation)
local TopBar = Instance.new("Frame", MainFrame)
TopBar.Size = UDim2.new(1,0,0,60)
TopBar.BackgroundTransparency = 1
TopBar.Active = true  -- Important for draggable
TopBar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)  -- Red background for debugging
TopBar.BackgroundTransparency = 1  -- Make it transparent but still clickable

local TitleContainer = Instance.new("Frame", TopBar)
TitleContainer.Size = UDim2.new(1,-120,1,0)
TitleContainer.Position = UDim2.new(0,12,0,0)
TitleContainer.BackgroundTransparency = 1

local Title = Instance.new("TextLabel", TitleContainer)
Title.Size = UDim2.new(1,0,0.6,0)
Title.Position = UDim2.new(0,0,0,0)
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.FredokaOne
Title.Text = UIConfig.Title  -- Shows "SyrexUI"
Title.TextColor3 = Theme.Text
Title.TextSize = UIConfig.TitleSize
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextYAlignment = Enum.TextYAlignment.Bottom

local Subtitle = Instance.new("TextLabel", TitleContainer)
Subtitle.Size = UDim2.new(1,0,0.4,0)
Subtitle.Position = UDim2.new(0,0,0.6,0)
Subtitle.BackgroundTransparency = 1
Subtitle.Font = Enum.Font.SourceSans
Subtitle.Text = UIConfig.Subtitle  -- Shows "SyrexUI" under title
Subtitle.TextColor3 = Color3.fromRGB(200,200,200)
Subtitle.TextSize = UIConfig.SubtitleSize
Subtitle.TextXAlignment = Enum.TextXAlignment.Left
Subtitle.TextYAlignment = Enum.TextYAlignment.Top

local CloseBtn = Instance.new("TextButton", TopBar)
CloseBtn.Size = UDim2.new(0,60,0,24)
CloseBtn.Position = UDim2.new(1,-70,0,5)
CloseBtn.BackgroundColor3 = Theme.Section
CloseBtn.Text = "Close"
CloseBtn.Font = Enum.Font.SourceSansBold
CloseBtn.TextColor3 = Theme.Text
CloseBtn.TextSize = 14
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0,6)

local MinBtn = Instance.new("TextButton", TopBar)
MinBtn.Size = UDim2.new(0,40,0,24)
MinBtn.Position = UDim2.new(1,-120,0,5)
MinBtn.BackgroundColor3 = Theme.Section
MinBtn.Text = "-"
MinBtn.Font = Enum.Font.SourceSansBold
MinBtn.TextColor3 = Theme.Text
MinBtn.TextSize = 18
Instance.new("UICorner", MinBtn).CornerRadius = UDim.new(0,6)

-- Simple Library Table
local SyrexUI = {
    Tabs = {},
    UIConfig = UIConfig
}

-- Loading function
local function showLoadingScreen()
    -- Animate loading bar
    local tweenInfo = TweenInfo.new(2, Enum.EasingStyle.Linear)
    local tween = TweenService:Create(LoadingBarFill, tweenInfo, {Size = UDim2.new(1, 0, 1, 0)})
    tween:Play()
    
    wait(2.2) -- Wait for loading animation
    
    -- Fade out loading screen
    local fadeTween = TweenService:Create(LoadingFrame, TweenInfo.new(0.5), {BackgroundTransparency = 1})
    fadeTween:Play()
    
    wait(0.5)
    LoadingFrame.Visible = false
    
    -- Show main UI
    MainFrame.Visible = true
    TabFrame.Visible = true
    ToggleBtn.Visible = true
end

-- CreateWindow with loading screen
function SyrexUI:CreateWindow(title, subtitle, loadingText)
    if title then
        UIConfig.Title = title
        Title.Text = title
        LoadingTitle.Text = title
    end
    if subtitle then
        UIConfig.Subtitle = subtitle
        Subtitle.Text = subtitle
    end
    if loadingText then
        UIConfig.LoadingText = loadingText
        LoadingSubtitle.Text = loadingText
    end
    
    -- Show loading screen first
    showLoadingScreen()
    
    -- Return window object with CreateTab method
    local window = {}
    
    function window:CreateTab(tabName)
        return SyrexUI:CreateTab(tabName)
    end
    
    function window:SetTitle(newTitle)
        if newTitle then
            UIConfig.Title = newTitle
            Title.Text = newTitle
            LoadingTitle.Text = newTitle
        end
    end
    
    function window:SetSubtitle(newSubtitle)
        if newSubtitle then
            UIConfig.Subtitle = newSubtitle
            Subtitle.Text = newSubtitle
        end
    end
    
    function window:SetLoadingText(newLoadingText)
        if newLoadingText then
            UIConfig.LoadingText = newLoadingText
            LoadingSubtitle.Text = newLoadingText
        end
    end
    
    return window
end

-- Method to configure UI appearance
function SyrexUI:UI(title, subtitle, loadingText, titleSize, subtitleSize, loadingTextSize)
    if title then 
        UIConfig.Title = title
        Title.Text = title
        LoadingTitle.Text = title
    end
    if subtitle then 
        UIConfig.Subtitle = subtitle
        Subtitle.Text = subtitle
    end
    if loadingText then 
        UIConfig.LoadingText = loadingText
        LoadingSubtitle.Text = loadingText
    end
    if titleSize then 
        UIConfig.TitleSize = titleSize
        Title.TextSize = titleSize
        LoadingTitle.TextSize = titleSize
    end
    if subtitleSize then 
        UIConfig.SubtitleSize = subtitleSize
        Subtitle.TextSize = subtitleSize
    end
    if loadingTextSize then 
        UIConfig.LoadingTextSize = loadingTextSize
        LoadingSubtitle.TextSize = loadingTextSize
    end
    return self
end

-- CreateTab
function SyrexUI:CreateTab(name)
    local content = Instance.new("ScrollingFrame", MainFrame)
    content.Size = UDim2.new(1,-24,1,-76)
    content.Position = UDim2.new(0,12,0,64)
    content.BackgroundTransparency = 1
    content.Visible = false
    content.ScrollingEnabled = true
    content.ScrollBarThickness = 6
    content.AutomaticCanvasSize = Enum.AutomaticSize.Y
    content.CanvasSize = UDim2.new(0,0,0,0)

    local btn = Instance.new("TextButton", TabFrame)
    btn.Size = UDim2.new(1,-10,0,40)
    btn.Position = UDim2.new(0,5,0,20+(#self.Tabs*50))
    btn.BackgroundColor3 = Theme.Section
    btn.Text = name
    btn.Font = Enum.Font.SourceSansBold
    btn.TextColor3 = Theme.Text
    btn.TextSize = 16
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)

    btn.MouseButton1Click:Connect(function()
        for _, t in pairs(self.Tabs) do
            t.content.Visible = false
            t.button.BackgroundColor3 = Theme.Section
        end
        content.Visible = true
        btn.BackgroundColor3 = Theme.Element
    end)

    if #self.Tabs==0 then
        content.Visible=true
        btn.BackgroundColor3 = Theme.Element
    end

    local elementCount = 0
    
    local function getYOffset()
        return elementCount * 42
    end

    local tab = {
        button = btn, 
        content = content,
        
        AddButton = function(self, text, callback)
            local yOffset = getYOffset()
            local btn = Instance.new("TextButton", content)
            btn.Size = UDim2.new(0.9,0,0,36)
            btn.Position = UDim2.new(0.05,0,0,yOffset)
            btn.BackgroundColor3 = Theme.Section
            btn.Font = Enum.Font.SourceSansBold
            btn.TextColor3 = Theme.Text
            btn.TextSize = 18
            btn.Text = text
            Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
            btn.MouseButton1Click:Connect(callback)
            elementCount = elementCount + 1
            return btn
        end,
        
        AddToggle = function(self, text, default, callback)
            local yOffset = getYOffset()
            local toggle = Instance.new("TextButton", content)
            toggle.Size = UDim2.new(0.9,0,0,36)
            toggle.Position = UDim2.new(0.05,0,0,yOffset)
            toggle.BackgroundColor3 = Theme.Section
            toggle.Font = Enum.Font.SourceSansBold
            toggle.TextColor3 = Theme.Text
            toggle.TextSize = 18
            toggle.Text = text..": "..(default and "ON" or "OFF")
            Instance.new("UICorner", toggle).CornerRadius = UDim.new(0,6)

            local state = default
            toggle.MouseButton1Click:Connect(function()
                state = not state
                toggle.Text = text..": "..(state and "ON" or "OFF")
                toggle.BackgroundColor3 = state and Theme.Element or Theme.Section
                if callback then callback(state) end
            end)
            elementCount = elementCount + 1
            return toggle
        end,
        
        AddSlider = function(self, text, min, max, default, callback)
            local yOffset = getYOffset()
            local sliderFrame = Instance.new("Frame", content)
            sliderFrame.Size = UDim2.new(0.9,0,0,32)
            sliderFrame.Position = UDim2.new(0.05,0,0,yOffset)
            sliderFrame.BackgroundTransparency = 1

            local bar = Instance.new("Frame", sliderFrame)
            bar.Size = UDim2.new(1,0,0,8)
            bar.Position = UDim2.new(0,0,0.5,-4)
            bar.BackgroundColor3 = Theme.Section
            Instance.new("UICorner", bar).CornerRadius = UDim.new(1,0)

            local fill = Instance.new("Frame", bar)
            fill.Size = UDim2.new((default-min)/(max-min),0,1,0)
            fill.BackgroundColor3 = Theme.Element
            Instance.new("UICorner", fill).CornerRadius = UDim.new(1,0)

            local valueLabel = Instance.new("TextLabel", sliderFrame)
            valueLabel.Position = UDim2.new(1,-50,0,-4)
            valueLabel.Size = UDim2.new(0,50,1,0)
            valueLabel.BackgroundTransparency = 1
            valueLabel.TextColor3 = Theme.Text
            valueLabel.Font = Enum.Font.SourceSansBold
            valueLabel.TextSize = 14
            valueLabel.Text = tostring(default)

            local dragging = false
            bar.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                end
            end)
            bar.InputEnded:Connect(function() dragging = false end)
            UserInputService.InputChanged:Connect(function(input)
                if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                    local relX = math.clamp((input.Position.X - bar.AbsolutePosition.X) / bar.AbsoluteSize.X, 0, 1)
                    fill.Size = UDim2.new(relX,0,1,0)
                    local val = math.floor(min + relX*(max-min))
                    valueLabel.Text = tostring(val)
                    if callback then callback(val) end
                end
            end)
            elementCount = elementCount + 1
            return sliderFrame
        end,
        
        AddLabel = function(self, text)
            local yOffset = getYOffset()
            local label = Instance.new("TextLabel", content)
            label.Size = UDim2.new(0.9, 0, 0, 24)
            label.Position = UDim2.new(0.05, 0, 0, yOffset)
            label.BackgroundTransparency = 1
            label.Text = text
            label.TextColor3 = Theme.Text
            label.Font = Enum.Font.SourceSans
            label.TextSize = 14
            elementCount = elementCount + 1
            return label
        end,
        
        AddKeybind = function(self, text, defaultKey, callback)
            local yOffset = getYOffset()
            
            local keybindFrame = Instance.new("Frame", content)
            keybindFrame.Size = UDim2.new(0.9, 0, 0, 24)
            keybindFrame.Position = UDim2.new(0.05, 0, 0, yOffset)
            keybindFrame.BackgroundTransparency = 1

            local bindLabel = Instance.new("TextLabel", keybindFrame)
            bindLabel.Size = UDim2.new(0.6, 0, 1, 0)
            bindLabel.BackgroundTransparency = 1
            bindLabel.Font = Enum.Font.SourceSans
            bindLabel.Text = text .. ": " .. tostring(defaultKey)
            bindLabel.TextColor3 = Theme.Text
            bindLabel.TextSize = 14
            bindLabel.TextXAlignment = Enum.TextXAlignment.Left

            local setBindBtn = Instance.new("TextButton", keybindFrame)
            setBindBtn.Position = UDim2.new(0.62, 0, 0, 0)
            setBindBtn.Size = UDim2.new(0.36, 0, 1, 0)
            setBindBtn.BackgroundColor3 = Theme.Element
            setBindBtn.Font = Enum.Font.SourceSansBold
            setBindBtn.Text = "Set Bind"
            setBindBtn.TextColor3 = Theme.Text
            Instance.new("UICorner", setBindBtn).CornerRadius = UDim.new(0, 6)

            local currentKey = defaultKey
            
            setBindBtn.MouseButton1Click:Connect(function()
                setBindBtn.Text = "Press a key..."
                local conn
                conn = UserInputService.InputBegan:Connect(function(input, gp)
                    if gp then return end
                    if input.KeyCode ~= Enum.KeyCode.Unknown then
                        currentKey = input.KeyCode
                        bindLabel.Text = text .. ": " .. tostring(currentKey)
                        setBindBtn.Text = "Set Bind"
                        if callback then callback(currentKey) end
                        conn:Disconnect()
                    end
                end)
            end)
            
            elementCount = elementCount + 1
            return {
                GetKey = function() return currentKey end,
                SetKey = function(newKey)
                    currentKey = newKey
                    bindLabel.Text = text .. ": " .. tostring(currentKey)
                    if callback then callback(currentKey) end
                end
            }
        end,
        
        AddToggleKeybind = function(self, text)
            local yOffset = getYOffset()
            
            local keybindFrame = Instance.new("Frame", content)
            keybindFrame.Size = UDim2.new(0.9, 0, 0, 24)
            keybindFrame.Position = UDim2.new(0.05, 0, 0, yOffset)
            keybindFrame.BackgroundTransparency = 1

            local bindLabel = Instance.new("TextLabel", keybindFrame)
            bindLabel.Size = UDim2.new(0.6, 0, 1, 0)
            bindLabel.BackgroundTransparency = 1
            bindLabel.Font = Enum.Font.SourceSans
            bindLabel.Text = text .. ": " .. tostring(Settings.CloseBind)
            bindLabel.TextColor3 = Theme.Text
            bindLabel.TextSize = 14
            bindLabel.TextXAlignment = Enum.TextXAlignment.Left

            local setBindBtn = Instance.new("TextButton", keybindFrame)
            setBindBtn.Position = UDim2.new(0.62, 0, 0, 0)
            setBindBtn.Size = UDim2.new(0.36, 0, 1, 0)
            setBindBtn.BackgroundColor3 = Theme.Element
            setBindBtn.Font = Enum.Font.SourceSansBold
            setBindBtn.Text = "Set Bind"
            setBindBtn.TextColor3 = Theme.Text
            Instance.new("UICorner", setBindBtn).CornerRadius = UDim.new(0, 6)
            
            setBindBtn.MouseButton1Click:Connect(function()
                setBindBtn.Text = "Press a key..."
                local conn
                conn = UserInputService.InputBegan:Connect(function(input, gp)
                    if gp then return end
                    if input.KeyCode ~= Enum.KeyCode.Unknown then
                        Settings.CloseBind = input.KeyCode
                        bindLabel.Text = text .. ": " .. tostring(Settings.CloseBind)
                        setBindBtn.Text = "Set Bind"
                        conn:Disconnect()
                    end
                end)
            end)
            elementCount = elementCount + 1
        end
    }
    
    table.insert(self.Tabs, tab)
    return tab
end

-- Toggle Button functionality
ToggleBtn.MouseButton1Click:Connect(function()
    Gui.Enabled = not Gui.Enabled
    ToggleBtn.Text = Gui.Enabled and "Close" or "Open"
end)

-- Close / Minimize - FIXED: Keep width consistent
local minimized = false
MinBtn.MouseButton1Click:Connect(function()
    minimized = not minimized
    if minimized then
        for _, t in pairs(SyrexUI.Tabs) do
            t.content.Visible = false
        end
        MainFrame.Size = UDim2.new(0,520,0,60)
    else
        for _, t in pairs(SyrexUI.Tabs) do
            t.content.Visible = (t.button.BackgroundColor3 == Theme.Element)
        end
        MainFrame.Size = UDim2.new(0,520,0,340)
    end
end)

CloseBtn.MouseButton1Click:Connect(function()
    Gui.Enabled = false
    ToggleBtn.Text = "Open"
end)

-- Keybind to toggle GUI
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Settings.CloseBind then
        Gui.Enabled = not Gui.Enabled
        ToggleBtn.Text = Gui.Enabled and "Close" or "Open"
    end
end

-- FIXED DRAGGABLE FUNCTION
local function MakeDraggable(topbar, frame)
    local dragging = false
    local dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end

    topbar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position

            local connection
            connection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    connection:Disconnect()
                end
            end)
        end
    end)

    topbar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

-- Make toggle button draggable
local toggleDragging = false
local toggleDragStart, toggleStartPos

ToggleBtn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        toggleDragging = true
        toggleDragStart = input.Position
        toggleStartPos = ToggleBtn.Position

        local connection
        connection = input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                toggleDragging = false
                connection:Disconnect()
            end
        end)
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if toggleDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - toggleDragStart
        ToggleBtn.Position = UDim2.new(
            toggleStartPos.X.Scale, toggleStartPos.X.Offset + delta.X,
            toggleStartPos.Y.Scale, toggleStartPos.Y.Offset + delta.Y
        )
    end
end)

-- Apply draggable to frames (FIXED - call this after frames are created)
spawn(function()
    wait(0.1) -- Small delay to ensure frames are created
    MakeDraggable(TopBar, MainFrame)
    MakeDraggable(TabFrame, TabFrame)
end)

-- Return the library
return SyrexUI
